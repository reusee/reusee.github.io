<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>go处理错误的另一种方式</title>
  <meta name="description" content="go处理错误的另一种方式">
  <meta name="author" content="">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://reusee.github.iocss/fonts.css">
  
  
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="http://reusee.github.iocss/custom.css">

  
  
  <link rel="stylesheet" href="http://reusee.github.iohighlight/styles/default.css">
  
  <script src="http://reusee.github.iohighlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="/" class="site-title pure-menu-heading">声zzz</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="http://reusee.github.ioabout/" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">声zzz</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="http://reusee.github.ioabout" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
                    <time class="">2015-10-01</time>
		            
                    
                    

                    

                    
                </p>
                <h1>go处理错误的另一种方式</h1>
            </div>

            <div class="post-content">
                <p>go处理错误常见的方式是</p>

<pre><code class="language-go">
err := funcReturningError()
if err != nil {
  // 处理错误
}
</code></pre>

<p>然而因为过于繁琐而饱受诟病。下文简述另一种处理错误的写法。</p>

<p>这种写法最初我是从标准库里看到的，代码在 <a href="https://github.com/golang/go/blob/master/src/encoding/gob/error.go。">https://github.com/golang/go/blob/master/src/encoding/gob/error.go。</a>
简言之，就是将错误用panic抛出，然后在某个边界用defer将其转为error值。这和其他用抛异常来处理错误的语言类似。
不过上述代码并不十分通用，也没有解决最开始提出的写法繁琐的问题。
受其启发，我现在用得最多的错误处理方式是这样的 <a href="https://github.com/reusee/codes/blob/master/err/err.go。">https://github.com/reusee/codes/blob/master/err/err.go。</a></p>

<p>首先是Err结构体，定义如下</p>

<pre><code class="language-go">
type Err struct {
  Pkg, Info string
  Err error
}
</code></pre>

<p>Pkg用于标识抛出错误的包，Info是对错误的描述。Err用于包装另一个错误，一般是当前函数所调用的函数返回的，可以实现类似java的chained exception的机制，后面再细说。</p>

<p>另外有一个me函数（make error），用于包装error，实现很简单不提。</p>

<p>然后是ce函数（check error）</p>

<pre><code class="language-go">
func ce(err error, info string) {
  if err != nil {
    panic(me(err, info))
  }
}
</code></pre>

<p>这个函数检查err参数是否为nil，如果不是，则包装出一个Err结构，然后用panic抛出。
这个就是用于替代if err != nil { &hellip; }的了。</p>

<p>错误用panic抛出后，必须在某个边界recover，API不应该对外暴露panic，否则会和go社区整体的理念不合，自找烦恼。
负责这个的是ct函数（catch error）</p>

<pre><code class="language-go">
func ct(err *error) {
  if p := recover(); p != nil {
    if e, ok := p.(error); ok {
      *err = e
    } else {
      panic(p)
    }
  }
}
</code></pre>

<p>因为用到了recover，所以ct只能在defer函数里调用。它首先recover()，然后看是否是error，是则将其赋值到传入的*error处，否则重新panic抛出</p>

<p>来看看它是如何减少代码的，以 <a href="https://blog.golang.org/errors-are-values">https://blog.golang.org/errors-are-values</a> 的一段代码为例</p>

<pre><code class="language-go">
_, err = fd.Write(p0[a:b])
if err != nil {
  return err
}
_, err = fd.Write(p1[c:d])
if err != nil {
  return err
}
_, err = fd.Write(p2[e:f])
if err != nil {
  return err
}
</code></pre>

<p>用上述机制，可以写成</p>

<pre><code class="language-go">
defer ct(&err)
_, err = fd.Write(p0[a:b])
ce(err, "write p0")
_, err = fd.Write(p1[c:d])
ce(err, "write p1")
_, err = fd.Write(p2[e:f])
ce(err, "write p2")
</code></pre>

<p>代码没有那样繁琐了。</p>

<p>另外还有一个好处是，因为Err包装了上一个错误，所以定位错误比较容易。例如下面程序</p>

<pre><code class="language-go">
package main

func foo() (err error) {
    defer ct(&err)
    ce(bar(), "call bar")
    return
}

func bar() (err error) {
    defer ct(&err)
    ce(baz(), "call baz")
    return
}

func baz() (err error) {
    return me(nil, "baz")
}

func main() {
    if err := foo(); err != nil {
        panic(err)
    }
}
</code></pre>

<p>paniclog是这样的</p>

<pre>
panic: foobar: call bar
foobar: call baz
foobar: baz
...
</pre>

<p>可以看出最外层的error包含了直到最内层的信息，包括包名foobar（这里只用到一个包所以体现不出），比起直接将最内层的error往上抛，要直观得多。</p>

<p>最后说说这种写法的缺点。首先是不论有无错误都调用recover，调用recover又要使用defer函数，所以性能会受到影响。
另外因为没有 if 语句了，做覆盖测试的话，区分不出两种case了。
所以这种写法并不适合所有场景。需要压榨性能时不用，需要做覆盖测试时不用。
适合的场景是对性能要求不高的，对正确性要求也不高的。
我会用在经常变的应用代码，或者百几十行的小程序里。
基础的包，还是好好写 if err != nil { &hellip; } 吧。</p>

<p><a href="https://github.com/reusee/codes/blob/master/err/err.go">https://github.com/reusee/codes/blob/master/err/err.go</a> 里的函数都不是public的，因为我使用时，是用代码生成工具复制出来用的，不需要public。
用的代码生成工具是 <a href="https://github.com/reusee/ccg">https://github.com/reusee/ccg</a> ，可能会有另外一篇博文说说这个。</p>

            </div>
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">:</li>

                

                

                

                

                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="http://reusee.github.iojs/jquery.min.js" type="text/javascript"></script>
<script src="http://reusee.github.iojs/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

